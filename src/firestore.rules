
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for data validation
    function isUserProfile(data) {
      return data.uid is string &&
             data.email is string &&
             (!('displayName' in data) || data.displayName is string || data.displayName == null) &&
             (!('photoURL' in data) || data.photoURL is string || data.photoURL == null) &&
             'plan' in data && (data.plan == 'Free' || data.plan == 'Pay-as-you-go' || data.plan == 'Lifetime Deal') &&
             'creditsUsed' in data && data.creditsUsed is number &&
             'creditsTotal' in data && data.creditsTotal is number;
    }

    // Validates the initial creation of a list document
    function isListCreate(data) {
      return data.name is string &&
             data.createdAt is number &&
             data.emailCount is number &&
             data.userId is string && data.userId == request.auth.uid &&
             data.progress == 0 &&
             data.good == 0 &&
             data.risky == 0 &&
             data.bad == 0 &&
             data.status == 'Processing' &&
             !('data' in data); // data field must not exist on create
    }

    // Validates updates to a list document
    function isListUpdate(data) {
      return data.name is string &&
             data.createdAt is number &&
             data.emailCount is number &&
             data.userId is string && data.userId == request.auth.uid &&
             'progress' in data && data.progress is number &&
             'good' in data && data.good is number &&
             'risky' in data && data.risky is number &&
             'bad' in data && data.bad is number &&
             'status' in data && data.status is string &&
             (!('data' in data) || data.data is list);
    }
    
    function isNewsletterSubscriber(data) {
      return data.email is string &&
             data.email.matches('.+@.+\\..+') &&
             data.subscribedAt is number;
    }

    match /users/{userId} {
      // Users can only read and write their own profile
      allow read: if request.auth.uid == userId;
      
      // Allow creation only if the data is valid and required fields are present
      allow create: if request.auth.uid == userId &&
                       isUserProfile(request.resource.data) &&
                       request.resource.data.uid == userId &&
                       request.resource.data.plan == 'Free' &&
                       request.resource.data.creditsTotal == 1000 &&
                       request.resource.data.creditsUsed == 0;

      // Allow update with validation
      allow update: if request.auth.uid == userId &&
                       isUserProfile(request.resource.data) &&
                       // Prevent user from changing their uid, email, and creditsUsed
                       request.resource.data.uid == resource.data.uid &&
                       request.resource.data.email == resource.data.email &&
                       request.resource.data.creditsUsed == resource.data.creditsUsed;
                       // Any other fields (plan, creditsTotal, displayName, photoURL) can be updated.

      match /lists/{listId} {
        // Users can only manage their own lists
        allow read, delete: if request.auth.uid == userId;

        // Use isListCreate for creation
        allow create: if request.auth.uid == userId && isListCreate(request.resource.data);

        // Use isListUpdate for updates
        allow update: if request.auth.uid == userId && isListUpdate(request.resource.data) &&
                       request.resource.data.userId == resource.data.userId;
      }
    }
     match /subscribers/{subscriberId} {
      // Anyone can create a subscription
      allow create: if isNewsletterSubscriber(request.resource.data);
      // No one can read, update, or delete subscriber emails from the client
      allow read, update, delete: if false;
    }
  }
}
